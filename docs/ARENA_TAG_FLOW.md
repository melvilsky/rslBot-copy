# Порядок действий: Arena Tag

Описан **текущий** порядок действий при запуске задачи Arena Tag. Используется общая логика `ArenaFactory`; от Arena Classic отличаются координаты (из `coordinates/arena_tag.json`), список позиций противников (`TAG_ITEM_LOCATIONS`), а также логика боя: Quick Battle вместо Auto-Battle и ожидание TAP TO CONTINUE вместо `waiting_battle_end_regular`.

---

## Уровень 1: Запуск задачи

1. Вызывается `Location.run(upd, ctx)` (из пресета/очереди).
2. **Перед стартом:** сброс `completed` при смене дня, проверка релогина при попапе ошибки.
3. **Старт:** `duration.start()` → **enter()** → **publish('run')** → **finish()**.

---

## Уровень 2: Вход в локацию (`enter` → `_enter`)

4. **`app.prepare(calibrate=False)`** — подготовка окна (без калибровки).
5. **`click_on_progress_info()`** — клик по области монет/ресурсов (поиск `all_resources.jpg`).
6. **Клик по области тиров:** `click(600, x_axis_info)` — для Arena Tag `x_axis_info = 135` (из `arena_tag.json`).
7. **`sleep(1)`**.
8. **`obtain()`** — забор наград (см. ниже).

---

## Уровень 3: Забор наград при входе (`obtain`)

9. **Проверка красной точки на тирах:** пиксель `tiers_coordinate` (152, 304) с цветом `RGB_RED_DOT` — есть ли непросмотренная награда.
10. **Если да:**
    - клик по `(152, 304)`;
    - **sleep(1)**;
    - до 3 свайпов вправо по `swipe_reward_coord` (из `arena_shared.json`), поиск `find_needle_arena_reward()`;
    - при нахождении точки: клик по сундуку → **sleep(1)** → клик **claim_chest** (455, 455) → **sleep(1)**;
    - переход на вкладку боя: клик **tab_battle** (110, 115) → **sleep(0.3)**.
11. Если красной точки нет — шаги 10 не выполняются, сразу переход к `run`.

---

## Уровень 4: Основной цикл (`_run`)

12. **Опционально:** если в конфиге для Arena Tag задан `initial_refresh: true` — вызывается **`_refresh_arena()`** (см. ниже), затем **sleep(1)**.
13. **Цикл** `while not terminated`:
    - **attack()** — один проход по списку противников (до 10 боев);
    - **last_results = _get_last_results()** — результаты последней серии;
    - если есть поражение **или** сыграно меньше 10 боев → **`_refresh_arena()`**;
    - иначе цикл повторяется (следующая серия атак без обновления списка).

---

## Уровень 5: Обход списка противников (`attack`)

Используется **TAG_ITEM_LOCATIONS** — 10 позиций: 7 раз позиция 1 (со свайпами 0…6), затем позиции 2, 3, 4 при 6 свайпах.

Для **каждой** позиции `i` (от 0 до 9):

14. **Свайп списка (inner_swipe):**
    - при `should_use_multi_swipe` (после первого боя в серии): делается `swipes_amount` свайпов вниз по `swipe_attack_coord` (580, 254), шаг `item_height` (105 для Tag);
    - иначе при `0 < i <= max_swipe`: один свайп вниз.
15. **Координаты кнопки атаки:** из `button_locations[position]` (arena_tag: позиции 1–4 — y 200, 300, 396, 490; x 855).
16. **Проверка:** пиксель в `(x, y)` цвета `ATTACK_BUTTON_RGB` **и** этот противник ещё не атакован в этой серии.
17. **Если условие выполнено:**
    - **click_on_battle()** — клик по кнопке атаки (x, y) → **sleep(1.5)**;
    - **Проверка Quick Battle:** пиксель `quick_battle` (710, 386) из `arena_shared.json`. Если цвет совпадает с неактивным чекбоксом [13, 58, 81] — кликаем для включения. Если не совпадает — Quick Battle уже включён (автобой тоже), пропускаем;
    - **click_on_start()** — клик по кнопке Start/Confirm (`start_battle_coord`: 860, 480) → **sleep(0.5)**;
    - **Проверка докупки:** если **`_refill()`** вернул True (сделана докупка) → повторный **click_on_start()**;
    - **Ожидание TAP TO CONTINUE:** вместо `waiting_battle_end_regular` ожидаем появления белого пикселя `tap_to_continue` (450, 470) из `arena_shared.json`. Проверка каждые 2 секунды;
    - **Результат:** победа = не виден пиксель `defeat` (443, 51);
    - **Клик TAP TO CONTINUE:** клик по (450, 470) → **sleep(2)** — закрытие экрана результата;
    - **should_use_multi_swipe = True** — для следующих итераций списка делаются множественные свайпы вниз.
18. Результаты серии добавляются в **results**; цикл по позициям продолжается до 10 или до **terminated**.

---

## Уровень 6: Обновление списка и рефилл (`_refresh_arena`)

19. **Чтение монет:** `read_coins_predicate()` — для Arena Tag это **read_bank_arena_tag()** (поиск `bank_arena_tag.jpg`, регион монет из `arena_tag.json`: coins_region).
20. **Если монет 0:**
    - клик чуть левее/ниже региона монет: `(region[0]-5, region[1]+5)`;
    - **`_refill()`** (см. ниже).
21. **Ожидание:** **awaits([E_BUTTON_REFRESH, E_TERMINATE])** — каждые 5 сек проверка: видна ли кнопка обновления (button_refresh 817,133) или флаг **terminated**. При кнопке обновления — **callback_refresh()**.

---

## Уровень 7: Докупка проходок (`_refill`)

22. **sleep(1)**.
23. Поиск кнопки рубиновой докупки: **find_needle_refill_ruby()**.
24. **Если кнопка найдена** (бесплатного рефилла нет):
    - при **refill > 0:** сохранение покупки (**increment_purchase**), уменьшение **refill**, клик **refill_click** (439, 395), **refilled = True**;
    - иначе: лог "No more refill", **terminated = True**.
25. **Иначе** проверка пикселя бесплатного рефилла **refill_free** (455, 380); при совпадении — клик **refill_click**, **refilled = True**.
26. **sleep(0.5)**. Возврат **refilled**.

---

## Уровень 8: Завершение

27. После выхода из цикла **`_run`**: **finish()** — закрытие попапов, **duration.end()**, лог и отправка сообщения "Done: Arena Tag | Duration: ...".

---

## Сводка порядка (кратко)

| №  | Действие |
|----|----------|
| 1  | Подготовка окна, клик по прогрессу, клик (600, 135) |
| 2  | **obtain:** красная точка на тирах → клик тиров → свайпы наград → клик сундук → claim → вкладка «Битва» |
| 3  | При необходимости: initial_refresh (монеты → рефилл → ожидание кнопки Refresh) |
| 4  | **Цикл:** attack → при поражении или <10 боев → _refresh_arena |
| 5  | **attack:** для каждой из 10 позиций: свайп списка → проверка кнопки атаки → клик атака → Quick Battle → Start → (рефилл при 0 монет) → ожидание TAP TO CONTINUE → результат → клик TAP TO CONTINUE |
| 6  | **refresh:** чтение монет Arena Tag → при 0 клик по монетам → _refill → ожидание кнопки Refresh (или terminate) |
| 7  | **refill:** поиск рубиновой кнопки → при наличии и refill>0 докупка и клик refill_click; иначе проверка бесплатного рефилла и клик |
| 8  | finish |

---

## Дебаг-мод

При `"debug": true` в `config.json` автоматически логируются:

- **Все пиксельные проверки** (`pixel_check_new`): координаты, ожидаемый RGB, фактический RGB, разница, порог, результат.
- **Все клики** (`click`): координаты + скриншот области 200x200 с аннотацией.
- **await_click / pixels_wait**: входные пиксели и результат (найден / таймаут).
- **Ключевые моменты арены**: скриншоты перед проверкой кнопки атаки, перед Start, при результате боя, при TAP TO CONTINUE.

Скриншоты сохраняются в `debug/` и `debug/clicks/`.

---

## Где что менять

- **Координаты Arena Tag:** `coordinates/arena_tag.json` (кнопки 1–4, тиры, монеты, высота строки и т.д.).
- **Общие координаты** (кнопка обновления, рефилл, defeat, вкладка битвы, Start, claim, свайпы, **quick_battle**, **tap_to_continue**): `coordinates/arena_shared.json`.
- **Порядок/количество позиций в списке:** массив **TAG_ITEM_LOCATIONS** в `locations/arena/index.py` (сейчас 10 позиций: 7x позиция 1 + позиции 2, 3, 4).
- **Порядок шагов внутри attack/obtain/refresh:** методы **ArenaFactory** в `locations/arena/index.py` (`_enter`, `obtain`, `_run`, `attack`, `_refresh_arena`, `_refill`).

Если нужно изменить именно **порядок действий** (что за чем идёт), правки делаются в этих методах в `locations/arena/index.py`.
